import logging

from openai import AsyncOpenAI

from config import OPENAI_API_KEY
from data.studio_info import STUDIO, PRICES, FAQ, TRAINERS_INFO, ESCALATION_TRIGGERS

client = AsyncOpenAI(api_key=OPENAI_API_KEY)

SYSTEM_PROMPT = """
–¢—ã ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å—Ç—É–¥–∏–∏ –ø–∏–ª–∞—Ç–µ—Å–∞ Pilates Guru. –¢–≤–æ—ë –∏–º—è: –ú–∞—Ä–∏–Ω–∞.

–°–¢–£–î–ò–Ø:
–ê–¥—Ä–µ—Å: {address} ({metro})
–ì—Ä–∞—Ñ–∏–∫: {schedule}
–¢–µ–ª–µ—Ñ–æ–Ω: {phone}
Telegram: {telegram}

–¢–†–ï–ù–ï–†–´:
- –¢–∞–º–∞—Ä–∞: –æ–ø—ã—Ç —Å 2008–≥, —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Ä–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞–≤–º–∞–º–∏ (–∫–æ–ª–µ–Ω–∏/—Ç–∞–∑/–ø–æ–∑–≤–æ–Ω–æ—á–Ω–∏–∫)
- –î–∞—Ä—å—è: —Å 2018–≥, —Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è –ø–æ—Å–ª–µ —Ç—Ä–∞–≤–º –∏ –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–µ–π—Ä–æ—Ä–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è
- –ú–∞—Ä–∏–Ω–∞-—Ç—Ä–µ–Ω–µ—Ä: –º—è–≥–∫–∏–π –ø–æ–¥—Ö–æ–¥, –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
- –ú–∞—Ä–∏—è: –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–∏–ª–∞—Ç–µ—Å, –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥–∞—á–∞

–ü–†–ê–ô–°:
–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ: –°—Ç–∞—Ä—Ç–æ–≤–∞—è 2400‚ÇΩ, –†–∞–∑–æ–≤–∞—è 4400‚ÇΩ, –ê–±–æ–Ω–µ–º–µ–Ω—Ç 8 = 28800‚ÇΩ, –ê–±–æ–Ω–µ–º–µ–Ω—Ç 12 = 40800‚ÇΩ
–°–ø–ª–∏—Ç (2 —á–µ–ª): –†–∞–∑–æ–≤–∞—è 5500‚ÇΩ, –ê–±–æ–Ω–µ–º–µ–Ω—Ç 8 = 40000‚ÇΩ
–ì—Ä—É–ø–ø–æ–≤—ã–µ (–¥–æ 4 —á–µ–ª): –†–∞–∑–æ–≤–∞—è 1800‚ÇΩ, –ê–±–æ–Ω–µ–º–µ–Ω—Ç 4 = 6400‚ÇΩ, –ê–±–æ–Ω–µ–º–µ–Ω—Ç 8 = 11200‚ÇΩ
–ü–µ—Ä–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è (2400‚ÇΩ).

–ü–†–ê–í–ò–õ–ê:
- –ó–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 100% –æ–ø–ª–∞—Ç—ã
- –û—Ç–º–µ–Ω–∞/–ø–µ—Ä–µ–Ω–æ—Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∑–∞ 20+ —á–∞—Å–æ–≤
- –ú–µ–Ω–µ–µ 20 —á–∞—Å–æ–≤: 1-–π —Ä–∞–∑ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, 2-–π ‚Äî —Å–ø–∏—Å–∞–Ω–∏–µ

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –û–±—Ä–∞—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ "–í—ã"
- –ö—Ä–∞—Ç–∫–∏–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –≠–º–æ–¥–∑–∏ —Ä–µ–¥–∫–æ: —Ç–æ–ª—å–∫–æ üôè üòä ‚ù§Ô∏è
- –ù–µ –∏–∑–≤–∏–Ω—è—Ç—å—Å—è –∑–∞ –º–µ–ª–æ—á–∏
- –ù–µ –¥–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
- –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å —Å–∫–∏–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ –æ–Ω–∏ –µ—Å—Ç—å)

–≠–°–ö–ê–õ–ê–¶–ò–Ø ‚Äî –≤–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç [ESCALATE] –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ:
- –ú–µ–¥–∏—Ü–∏–Ω—É: –≥—Ä—ã–∂–∏, —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Ç—Ä–∞–≤–º—ã, –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è
- –°–∫–∏–¥–∫–∏ –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- –ñ–∞–ª–æ–±—ã, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π
"""


async def get_ai_response(
    user_message: str,
    chat_history: list | None = None,
    client_name: str | None = None
) -> dict:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    {"type": "answer", "text": "..."}
    {"type": "escalate"}
    {"type": "fallback"}
    """
    # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º –¥–æ –≤—ã–∑–æ–≤–∞ API
    lower = user_message.lower()
    if any(t in lower for t in ESCALATION_TRIGGERS):
        return {"type": "escalate"}

    if not OPENAI_API_KEY:
        return {"type": "fallback"}

    system = SYSTEM_PROMPT.format(**STUDIO)
    messages = [{"role": "system", "content": system}]

    if chat_history:
        messages.extend(chat_history[-8:])

    content = user_message
    if client_name:
        content = f"[–ö–ª–∏–µ–Ω—Ç: {client_name}] {user_message}"
    messages.append({"role": "user", "content": content})

    try:
        resp = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages,
            max_tokens=400,
            temperature=0.7,
        )
        text = resp.choices[0].message.content.strip()
        if "[ESCALATE]" in text:
            return {"type": "escalate"}
        return {"type": "answer", "text": text}
    except Exception as e:
        logging.error(f"OpenAI error: {e}")
        return {"type": "fallback"}
